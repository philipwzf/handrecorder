<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BBO Handviewer Workbench — Side‑by‑Side</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gap: 12px;
      --panel-bg: #f7f7fb;
      --border: #d9d9e3;
      --accent: #5b6cff;
      /* right panel (preview) width percentage; JS updates this */
      --right: 60%;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:#111;
      background:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    header h1{
      font-size:16px;
      margin:0 12px 0 0;
      font-weight:600;
      white-space:nowrap;
    }
    .small{ opacity:.75; font-size:12px; }
    .pill{
      border:1px dashed var(--border);
      border-radius:99px; padding:6px 10px; font-size:12px; color:#444;
    }

    /* NEW: side‑by‑side grid */
    .container{
      display:grid;
      grid-template-columns: calc(100% - var(--right)) var(--right);
      grid-template-rows: 1fr;
      height:calc(100vh - 57px);
    }
    .left{
      padding:16px;
      overflow:auto;
      background:var(--panel-bg);
      border-right:1px solid var(--border);
    }
    .right{
      position:relative;
      min-height:180px;
    }
    iframe{
      position:absolute; inset:0; width:100%; height:100%; border:0;
      background:#fff;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: var(--gap);
      margin-bottom: var(--gap);
      align-items:center;
    }
    .controls input[type="text"]{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:14px;
      background:#fff;
    }
    .btn{
      appearance:none; border:1px solid var(--border); background:#fff;
      border-radius:8px; padding:10px 12px; cursor:pointer; font-weight:600;
    }
    .btn.primary{ background: var(--accent); color:#fff; border-color: transparent; }

    .bar{ display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .bar input[type="range"]{ width:220px; }
    .muted{ opacity:.8; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
    }
    fieldset{
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      background:#fff;
      min-width:0;
    }
    legend{ padding: 0 6px; font-weight:700; color:#333; }
    label{ display:block; font-size:12px; margin-bottom:6px; color:#333; font-weight:600; }
    .row{ display:grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); }

    input[type="text"], textarea, select, input[type="number"]{
      width:100%; padding:9px 10px; border:1px solid var(--border); border-radius:8px; font: inherit; background:#fff;
    }
    textarea{ resize:vertical; min-height:48px; }
    .hint{ font-size:12px; color:#555; margin-top:6px; }
    .generated{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    .generated input{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .bad{ outline:2px solid #ff4d4f; }

    /* Mobile: stack vertically */
    @media (max-width: 980px){
      .container{
        grid-template-columns: 1fr;
        grid-template-rows: 50% 50%;
      }
      .left{ border-right:0; border-bottom:1px solid var(--border); }
      .grid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>BBO Handviewer Workbench</h1>
    <div class="small">Paste a Handviewer link → edit parts → preview on the right.</div>
    <div class="pill">Docs: bridgebase.com/tools/hvdoc.html</div>
  </header>

  <div class="container" id="container">
    <!-- LEFT: settings -->
    <section class="left">
      <!-- IMPORTER -->
      <fieldset style="margin-bottom:12px;">
        <legend>Import results & extract Handviewer links</legend>
        <div class="grid" style="grid-template-columns: 1fr; gap: var(--gap);">

          <div>
            <label for="resultHtml">Paste the page HTML</label>
            <textarea id="resultHtml" placeholder="Paste the HTML source of the results page here"></textarea>
          </div>

          <div class="row" style="grid-template-columns: 1fr auto auto; align-items:end;">
            <div>
              <label for="filePick">Or pick a saved .html file</label>
              <input id="filePick" type="file" accept=".html,.htm,text/html" />
            </div>
            <button class="btn" id="btnExtract">Extract from pasted</button>
            <button class="btn" id="btnClearList">Clear list</button>
          </div>

          <div class="bar" style="margin-top:4px;">
            <span class="muted" id="foundCount">No links yet.</span>
            <button class="btn ghost" id="btnCopyAll" style="display:none;">Copy all</button>
          </div>

          <div class="list" id="foundList" aria-live="polite"></div>

          <div class="hint">
            We detect any <code>handviewer.html</code> link with <code>?lin=</code> or explicit <code>n/e/s/w/a/p</code> params (also <code>myhand</code> / <code>linurl</code>).
            Links are normalized to the official endpoint: <code>https://www.bridgebase.com/tools/handviewer.html</code> per the Handviewer docs.
          </div>
        </div>
      </fieldset>
      <div class="controls">
        <input id="inputLink" type="text" placeholder="Paste a BBO Handviewer link (e.g., https://www.bridgebase.com/tools/handviewer.html?n=...&a=...)" />
        <div style="display:flex; gap:8px;">
          <button class="btn" id="btnParse">Parse link</button>
          <button class="btn" id="btnExample">Load example</button>
        </div>
      </div>

      <div class="bar">
        <label for="widthRange" class="muted">Preview width</label>
        <input id="widthRange" type="range" min="35" max="85" value="60" />
        <span id="widthVal" class="muted">60%</span>
      </div>

      <div class="grid">
        <fieldset style="grid-column: span 12;">
          <legend>Hands</legend>
          <div>
            <label for="nHand">North</label>
            <input id="nHand" type="text" placeholder="e.g. sAKQ hT98 dJ7 cA654" />
          </div>
          <div>
            <label for="eHand">East</label>
            <input id="eHand" type="text" placeholder="e.g. s... h... d... c..." />
          </div>
          <div>
            <label for="sHand">South</label>
            <input id="sHand" type="text" placeholder="e.g. s... h... d... c..." />
          </div>
          <div>
            <label for="wHand">West</label>
            <input id="wHand" type="text" placeholder="e.g. s... h... d... c..." />
          </div>
          <div class="hint">
            Use suit‑prefixed blobs (order s,h,d,c). Parameters map to <code>n</code>/<code>e</code>/<code>s</code>/<code>w</code> in the official Handviewer query format.
          </div>
        </fieldset>

        <fieldset style="grid-column: span 12;">
          <legend>Auction</legend>
          <label for="auction">Calls</label>
          <input id="auction" type="text" placeholder="e.g. 1s p 2s p 4s p p p" />
          <div class="hint">Space/comma separated. Use N for notrump (e.g., 1N), X for double, R for redouble.</div>
        </fieldset>

        <fieldset style="grid-column: span 12;">
          <legend>Play</legend>
          <label for="play">Cards (lead first)</label>
          <textarea id="play" placeholder="e.g. sj sq sk sa da c2 d4 d3"></textarea>
          <div class="hint">Cards are suit+rank: sj, h9, da, ct…</div>
        </fieldset>

        <fieldset style="grid-column: span 12;">
          <legend>Board Settings</legend>
            <div>
              <label for="dealer">Dealer</label>
              <select id="dealer">
                <option value="">(auto/unspecified)</option>
                <option value="n">North</option>
                <option value="e">East</option>
                <option value="s">South</option>
                <option value="w">West</option>
              </select>
            </div>
            <div>
              <label for="vul">Vulnerability</label>
              <select id="vul">
                <option value="">(none specified)</option>
                <option value="-">None</option>
                <option value="n">NS</option>
                <option value="e">EW</option>
                <option value="b">Both</option>
              </select>
            </div>
            <div>
              <label for="board">Board #</label>
              <input id="board" type="number" min="1" step="1" placeholder="e.g. 7" />
            </div>
            <div>
              <label for="claim">Claimed tricks</label>
              <input id="claim" type="number" min="0" step="1" placeholder="optional" />
            </div>

          <div class="generated">
            <label for="outputLink" style="margin:0;">Generated viewer link</label>
            <input id="outputLink" type="text" readonly />
            <button class="btn" id="btnCopy">Copy</button>
            <button class="btn primary" id="btnApply">Update Preview</button>
          </div>
          <div class="hint">
            Links are built per the Handviewer spec (params: n/e/s/w, a, p, d, v, b, c). See the docs in the header.
          </div>
        </fieldset>
      </div>
    </section>

    <!-- RIGHT: preview -->
    <section class="right">
      <iframe id="viewer" title="BBO Handviewer Preview"
              src="about:blank" allowfullscreen referrerpolicy="no-referrer"></iframe>
    </section>
  </div>

  <script>
    // ======= Utilities =======
    const $ = sel => document.querySelector(sel);
    const dec = s => { try { return decodeURIComponent(s); } catch { return s; } };
    const trim = s => (s||"").trim();
    const nonEmpty = v => v !== undefined && v !== null && String(v).trim() !== "";

    // Debounce for live updates
    const debounce = (fn, ms=350) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; };

    // ======= Handviewer Link Extraction =======
    function extractHandviewerLinks(htmlContent) {
      const links = [];
      
      // Pattern to match handviewer URLs
      const patterns = [
        /https?:\/\/[^\/]*bridgebase\.com\/tools\/handviewer\.html\?[^"'\s<>]*/gi,
        /\/\/[^\/]*bridgebase\.com\/tools\/handviewer\.html\?[^"'\s<>]*/gi,
        /handviewer\.html\?[^"'\s<>]*/gi
      ];
      
      patterns.forEach((pattern, index) => {
        console.log(`Testing pattern ${index + 1}:`, pattern);
        const matches = htmlContent.match(pattern) || [];
        console.log(`Pattern ${index + 1} found ${matches.length} matches:`, matches);
        
        matches.forEach(match => {
          console.log('Processing match:', match);
          let url = match;
          if (url.startsWith('//')) {
            url = 'https:' + url;
          } else if (url.startsWith('handviewer.html')) {
            url = 'https://www.bridgebase.com/tools/' + url;
          }
          
          console.log('Normalized URL:', url);
          const isValid = isValidHandviewerLink(url);
          console.log('Is valid:', isValid);
          
          if (isValid) {
            links.push(url);
          }
        });
      });

      return [...new Set(links)]; // Remove duplicates
    }
    function isValidHandviewerLink(url) {
      try {
        const urlObj = new URL(url);
        const params = urlObj.searchParams;
        
        const hasHandParams = params.has('n') || params.has('e') || params.has('s') || params.has('w');
        const hasOtherParams = params.has('lin') || params.has('myhand') || params.has('linurl');
        const hasAuctionPlay = params.has('a') || params.has('p');
        
        return hasHandParams || hasOtherParams || hasAuctionPlay;
      } catch {
        return false;
      }
    }

    function extractBoardInfo(url) {
      try {
        const urlObj = new URL(url);
        const params = urlObj.searchParams;
        
        let boardNum = params.get('b') || '';
        let players = {
          north: params.get('nn') || '',
          south: params.get('sn') || '',
          east: params.get('en') || '',
          west: params.get('wn') || ''
        };
        
        return {
          url: url,
          boardNumber: boardNum,
          players: players
        };
      } catch {
        return {
          url: url,
          boardNumber: '',
          players: { north: '', south: '', east: '', west: '' }
        };
      }
    }

    function displayFoundLinks(links) {
          const foundList = $('#foundList');
          const foundCount = $('#foundCount');
          const btnCopyAll = $('#btnCopyAll');
          
          if (links.length === 0) {
            foundCount.textContent = 'No handviewer links found.';
            foundList.innerHTML = '';
            btnCopyAll.style.display = 'none';
            return;
          }
          
          // Store links globally for pagination
          window.allFoundLinks = links;
          window.currentPage = 1;
          window.itemsPerPage = parseInt(localStorage.getItem('linksPerPage') || '10');
          
          renderPaginatedLinks();
        }

    function renderPaginatedLinks() {
  const links = window.allFoundLinks || [];
  const currentPage = window.currentPage || 1;
  const itemsPerPage = window.itemsPerPage || 10;
  
  const foundList = $('#foundList');
  const foundCount = $('#foundCount');
  const btnCopyAll = $('#btnCopyAll');
  
  // Calculate pagination
  const totalPages = Math.ceil(links.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, links.length);
  const currentLinks = links.slice(startIndex, endIndex);
  
  // Update count and show copy all button
  foundCount.textContent = `Found ${links.length} handviewer link${links.length === 1 ? '' : 's'}`;
  btnCopyAll.style.display = 'inline-block';
  
  // Create pagination controls
  const paginationHtml = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 6px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 12px; color: #666;">Show:</span>
        <select id="itemsPerPageSelect" style="padding: 4px 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
          <option value="1" ${itemsPerPage === 1 ? 'selected' : ''}>1</option>
          <option value="5" ${itemsPerPage === 5 ? 'selected' : ''}>5</option>
          <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
          <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
          <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
        </select>
        <span style="font-size: 12px; color: #666;">per page</span>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 12px; color: #666;">
          Showing ${startIndex + 1}-${endIndex} of ${links.length}
        </span>
        <div style="display: flex; gap: 4px; align-items: center;">
          <button class="btn" style="padding: 4px 8px; font-size: 11px;" 
                  onclick="changePage(${currentPage - 1})" 
                  ${currentPage === 1 ? 'disabled' : ''}>‹ Prev</button>
          <span style="padding: 4px 8px; font-size: 11px; color: #666;">
            Page
          </span>
          <input id="pageJumpInput" type="number" min="1" max="${totalPages}" value="${currentPage}" 
                 style="width: 50px; padding: 2px 4px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; text-align: center;"
                 onkeypress="handlePageJump(event, ${totalPages})" />
          <span style="padding: 4px 8px; font-size: 11px; color: #666;">
            of ${totalPages}
          </span>
          <button class="btn" style="padding: 4px 8px; font-size: 11px;" 
                  onclick="changePage(${currentPage + 1})" 
                  ${currentPage === totalPages ? 'disabled' : ''}>Next ›</button>
        </div>
      </div>
    </div>
  `;
  
  // Create links HTML
  const linksHtml = currentLinks.map((link, index) => {
    const globalIndex = startIndex + index;
    const info = extractBoardInfo(link);
    const boardText = info.boardNumber ? `Board ${info.boardNumber}` : `Link ${globalIndex + 1}`;
    const playersText = info.players.north || info.players.south ? 
      ` - ${info.players.north} & ${info.players.south} vs ${info.players.east} & ${info.players.west}` : '';
    
    return `
      <div style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; background: #fff;">
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; margin-bottom: 4px;">${boardText}${playersText}</div>
            <div style="font-family: ui-monospace, monospace; font-size: 12px; color: #666; word-break: break-all;">
              ${link}
            </div>
          </div>
          <div style="display: flex; gap: 8px; flex-shrink: 0;">
            <button class="btn" style="padding: 6px 10px; font-size: 12px;" onclick="loadHandviewerLink('${link.replace(/'/g, "\\'")}')">Load</button>
            <button class="btn" style="padding: 6px 10px; font-size: 12px;" onclick="copyToClipboard('${link.replace(/'/g, "\\'")}')">Copy</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  foundList.innerHTML = paginationHtml + linksHtml;
  
  // Add event listener for items per page change
  const select = $('#itemsPerPageSelect');
  if (select) {
    select.addEventListener('change', (e) => {
      window.itemsPerPage = parseInt(e.target.value);
      window.currentPage = 1; // Reset to first page
      localStorage.setItem('linksPerPage', window.itemsPerPage);
      renderPaginatedLinks();
    });
  }
}

    function handlePageJump(event, totalPages) {
  if (event.key === 'Enter') {
    const pageInput = event.target;
    const newPage = parseInt(pageInput.value);
    
    if (newPage >= 1 && newPage <= totalPages) {
      changePage(newPage);
    } else {
      // Reset to current page if invalid
      pageInput.value = window.currentPage || 1;
      // Optional: show a brief error indication
      pageInput.style.borderColor = '#ff4d4f';
      setTimeout(() => {
        pageInput.style.borderColor = 'var(--border)';
      }, 1000);
    }
  }
}
        // Add pagination functions
    function changePage(newPage) {
          const totalPages = Math.ceil((window.allFoundLinks || []).length / (window.itemsPerPage || 10));
          if (newPage >= 1 && newPage <= totalPages) {
            window.currentPage = newPage;
            renderPaginatedLinks();
          }
        }

        // Also update the copyAllLinks function to work with all links, not just visible ones:
    async function copyAllLinks() {
          const links = window.allFoundLinks || [];
          
          if (links.length > 0) {
            const allLinks = links.join('\n');
            await copyToClipboard(allLinks);
            $('#btnCopyAll').textContent = 'Copied!';
            setTimeout(() => $('#btnCopyAll').textContent = 'Copy all', 1200);
          }
        }

    function loadHandviewerLink(url) {
          $('#inputLink').value = url;
          parseLink();
        }

    async function copyToClipboard(text) {
          try {
            await navigator.clipboard.writeText(text);
          } catch (err) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }
        }

        // Event handlers for the import section
        $('#btnExtract').addEventListener('click', () => {
          const htmlContent = $('#resultHtml').value.trim();
          if (!htmlContent) {
            alert('Please paste some HTML content first.');
            return;
          }
          
          const links = extractHandviewerLinks(htmlContent);
          displayFoundLinks(links);
        });

        $('#btnClearList').addEventListener('click', () => {
          $('#foundList').innerHTML = '';
          $('#foundCount').textContent = 'No links yet.';
          $('#btnCopyAll').style.display = 'none';
          $('#resultHtml').value = '';
        });

        $('#btnCopyAll').addEventListener('click', copyAllLinks);

        $('#filePick').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            $('#resultHtml').value = event.target.result;
            const links = extractHandviewerLinks(event.target.result);
            displayFoundLinks(links);
          };
          reader.readAsText(file);
        });

    // Normalize a hand string to "s...h...d...c..." lowercase
    function normalizeHand(str){
      if(!str) return "";
      let s = str.replace(/\s+/g,"");
      s = s.replace(/S/g,'s').replace(/H/g,'h').replace(/D/g,'d').replace(/C/g,'c');
      s = s.replace(/[|,]/g,'');
      return s;
    }

    // Parse auction "1s p 2h x p p p" -> "1sp2hxppp"
    function normalizeAuction(str){
      if(!str) return "";
      let tokens = str.replace(/[|]/g,' ')
                      .replace(/,/g,' ')
                      .trim().split(/\s+/).filter(Boolean);
      const out = tokens.map(tok=>{
        let t = tok.toUpperCase().replace(/NT/g,'N');
        if(/^PASS$/i.test(t)) t='P';
        if(/^(DBL|DOUBLE)$/i.test(t)) t='X';
        if(/^(RDBL|REDOUBLE)$/i.test(t)) t='R';
        return t.toLowerCase();
      }).join('');
      return out;
    }

    // Parse play "sj sq sk sa" etc. -> "sjsqsksa"
    function normalizePlay(str){
      if(!str) return "";
      let tokens = str.replace(/[|,]/g,' ')
                      .trim().split(/\s+/).filter(Boolean);
      let ok = /^[shdc][2-9tjqka]$/i;
      let bad = false;
      tokens = tokens.map(t=>{
        let x = t.toLowerCase();
        if(!ok.test(x)) bad = true;
        return x;
      });
      $('#play').classList.toggle('bad', bad);
      return tokens.join('');
    }

    // Build the viewer URL from current fields
    function buildUrl(){
      const base = 'https://www.bridgebase.com/tools/handviewer.html';
      const params = new URLSearchParams();

      const n = normalizeHand($('#nHand').value);
      const e = normalizeHand($('#eHand').value);
      const s = normalizeHand($('#sHand').value);
      const w = normalizeHand($('#wHand').value);
      const a = normalizeAuction($('#auction').value);
      const p = normalizePlay($('#play').value);
      const d = $('#dealer').value;
      const v = $('#vul').value;
      const b = trim($('#board').value);
      const c = trim($('#claim').value);

      if(nonEmpty(n)) params.set('n', n);
      if(nonEmpty(e)) params.set('e', e);
      if(nonEmpty(s)) params.set('s', s);
      if(nonEmpty(w)) params.set('w', w);
      if(nonEmpty(a)) params.set('a', a);
      if(nonEmpty(p)) params.set('p', p);
      if(nonEmpty(d)) params.set('d', d);
      if(nonEmpty(v)) params.set('v', v);
      if(nonEmpty(b)) params.set('b', b);
      if(nonEmpty(c)) params.set('c', c);

      const url = params.toString() ? `${base}?${params.toString()}` : base;
      $('#outputLink').value = url;
      return url;
    }

    function applyToViewer(){ $('#viewer').src = $('#outputLink').value || 'about:blank'; }
    const applyDebounced = debounce(()=>{ buildUrl(); applyToViewer(); }, 500);

    // ======= Parsing a pasted Handviewer link =======
    function parseLink(){
      const raw = trim($('#inputLink').value);
      if(!raw) return;

      let href = raw;
      if(/^\/\//.test(href)) href = 'https:' + href;
      if(/^\?/.test(href)) href = 'https://www.bridgebase.com/tools/handviewer.html' + href;

      let u;
      try{ u = new URL(href); }catch(e){
        alert('That does not look like a valid URL.');
        return;
      }
      const sp = u.searchParams;

      const fill = (id, key) => { if(sp.get(key)) $(id).value = dec(sp.get(key)); };

      // Reset first
      ['#nHand','#eHand','#sHand','#wHand','#auction','#play','#board','#claim'].forEach(id => $(id).value = '');
      ['#dealer','#vul'].forEach(id => $(id).value = '');

      if(sp.has('n') || sp.has('s') || sp.has('e') || sp.has('w') || sp.has('a') || sp.has('p')){
        fill('#nHand','n'); fill('#eHand','e'); fill('#sHand','s'); fill('#wHand','w');
        fill('#auction','a'); fill('#play','p');
        fill('#board','b'); fill('#claim','c');
        if(sp.get('d')) $('#dealer').value = sp.get('d').toLowerCase();
        if(sp.get('v')) $('#vul').value    = sp.get('v').toLowerCase();
        buildUrl(); applyToViewer();
        return;
      }

      if(sp.has('lin')){
        const lin = dec(sp.get('lin'));
        parseLinStringIntoFields(lin);
        buildUrl(); applyToViewer();
        return;
      }

      if(sp.has('myhand') || sp.has('linurl')){
        $('#outputLink').value = href;
        applyToViewer();
        alert('This link references a remote movie (myhand/linurl). I can preview it on the right, but cannot parse it into editable fields.');
        return;
      }

      alert('Could not find recognizable Handviewer parameters in that link.');
    }

    // Parse a LIN movie string into our editable fields
    function parseLinStringIntoFields(lin){
      const t = lin.split('|');
      const bids = [];
      const plays = [];
      let claim = '';
      let dealerDigit = null;
      let sHand='', wHand='', nHand='', eHand='';
      let vul='', board='';

      for(let i=0; i<t.length; i+=2){
        const tag = (t[i]||'').trim().toLowerCase();
        const val = (t[i+1]||'').trim();

        if(!tag) { i -= 1; continue; }

        if(tag === 'md'){
          if(val.length){
            dealerDigit = val[0];
            const body = val.slice(1);
            const parts = body.split(',');
            sHand = normalizeHand(parts[0]||'');
            wHand = normalizeHand(parts[1]||'');
            nHand = normalizeHand(parts[2]||'');
            eHand = normalizeHand(parts[3]||'');
          }
        }
        else if(tag === 'sv'){ vul = val.toLowerCase(); }
        else if(tag === 'ah'){ const m = /board\s+(\d+)/i.exec(val); if(m) board = m[1]; }
        else if(tag === 'mb'){ bids.push(val.toUpperCase().replace(/NT/g,'N').toLowerCase()); }
        else if(tag === 'pc'){ plays.push(val.toLowerCase()); }
        else if(tag === 'mc'){ claim = val; }
      }

      const dealerMap = { '1':'s', '2':'w', '3':'n', '4':'e' };
      const d = dealerMap[String(dealerDigit)] || '';

      $('#nHand').value = nHand; $('#eHand').value = eHand; $('#sHand').value = sHand; $('#wHand').value = wHand;
      $('#auction').value = bids.join(' ');
      $('#play').value    = plays.join(' ');
      $('#dealer').value = d || '';
      $('#vul').value    = vul || '';
      $('#board').value  = board || '';
      $('#claim').value  = claim || '';
    }

    // ======= Wire up events =======
    $('#btnParse').addEventListener('click', parseLink);
    $('#btnApply').addEventListener('click', ()=>{ buildUrl(); applyToViewer(); });
    $('#btnCopy').addEventListener('click', async ()=>{
      const v = $('#outputLink').value;
      if(!v) return;
      try{ await navigator.clipboard.writeText(v);
        $('#btnCopy').textContent = 'Copied!';
        setTimeout(()=>$('#btnCopy').textContent='Copy',1200);
      }catch{}
    });
    $('#btnExample').addEventListener('click', ()=>{
      const example = 'https://www.bridgebase.com/tools/handviewer.html?lin='
        + encodeURIComponent('md|1S2389JHTD3JC237KA,S7TH4QKD678TC4569,S456KAH25D25KACJQ,|rh||ah|Board 7|sv|b|mb|p|mb|p|mb|1S|mb|2H|mb|3S|mb|p|mb|4D|mb|p|mb|4S|mb|p|mb|p|mb|p|pg||pc|SQ|pc|S2|pc|S7|pc|SA|pg||pc|SK|pc|H3|pc|S8|pc|ST|pg||pc|CQ|pc|C8|pc|C2|pc|C4|pg||pc|CJ|pc|CT|pc|C3|pc|C5|pg||mc|13|');
      $('#inputLink').value = example;
      parseLink();
    });

    ['#nHand','#eHand','#sHand','#wHand','#auction','#play','#dealer','#vul','#board','#claim']
      .forEach(id => $(id).addEventListener('input', applyDebounced));

    // NEW: preview width control (right panel)
    const widthRange = $('#widthRange');
    const container = $('#container');
    widthRange.addEventListener('input', ()=>{
      const v = +widthRange.value;
      $('#widthVal').textContent = v + '%';
      // set a custom property so media queries can still re-layout on mobile
      container.style.setProperty('--right', v + '%');
    });

    // Initialize URL + preview + width label
    (function init(){
      $('#widthVal').textContent = widthRange.value + '%';
      buildUrl();
      // don't auto-load a blank iframe until user edits or parses
    })();
  </script>
</body>
</html>
